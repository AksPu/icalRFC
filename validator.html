<html>
  <head>
    <script type="text/javascript" src="ical.jsm"></script>
    <script type="text/javascript">
      function stringError(e) {
        return "Error: " + e +
               ("fileName" in e ? "\nFilename: " + e.fileName : "") +
               ("lineNumber" in e ? "\nLine: " + e.lineNumber : "") +
               ("stack" in e ? "\nStack: " + e.stack : "");
      }
      function jsonReplacer(key, value) {
          // Remove properties that could cause cyclic references
          if (key == "wrappedJSObject" || key == "parent") {
              return undefined;
          }

          // Avoid double information for decorated objects
          if (key == "properties" || key == "components") {
              return "...";
          }

          if (value && value.icaltype) {
              return value.toString();
          }

          return value;
      }

      function validate() {
        var data = document.getElementById("data");
        var decorate = document.getElementById("decorate").checked;

        var error = document.getElementById("error");
        var results = document.getElementById("results");

        var serialize_error = document.getElementById("serialize_error");
        var reserialized = document.getElementById("reserialized");

        var undecorate_error = document.getElementById("undecorate_error");
        var undecorated = document.getElementById("undecorated");

        var sourceResult, jsonResult, icalResult, undecResult;

        error.textContent = serialize_error.textContent = undecorate_error.textContent = "";
        results.textContent = reserialized.textContent = undecorated.textContent =  "";
        try {
            // First load the source representation
            sourceResult = ICAL.toJSON(data.value, decorate)
            results.textContent = sourceResult.toSource();

            // Try to jsonify it
            jsonResult = JSON.stringify(sourceResult, jsonReplacer, " ");
            results.textContent = jsonResult;
        } catch (e) {
            error.textContent = stringError(e);
        }

        try {
            // Try to reserialize it
            icalResult = ICAL.toIcalString(sourceResult);
            reserialized.textContent = icalResult;
        } catch (e) {
            serialize_error.textContent = stringError(e);
        }

        if (decorate) {
            try {
                // Try to undecorate it
                undecResult = sourceResult.undecorate();
                undecorated.textContent = undecResult.toSource();

                // Try to jsonify it
                jsonResult = JSON.stringify(undecResult, jsonReplacer, " ");
                undecorated.textContent = jsonResult;
            } catch (e) {
                undecorate_error.textContent = stringError(e);
            }
        }

        return false;
      }

    </script>
  </head>
  <body>
    <form method="post" action="#" onsubmit="return validate()">
      <textarea id="data" rows="20" cols="80"></textarea><br/>
      <input type="checkbox" id="decorate">Decorate</input>
      <input type="submit" value="Validate"/><br/>
      <hr>
      <pre id="error"></pre>
      <pre id="results"></pre>
      <hr>
      <pre id="serialize_error"></pre>
      <pre id="reserialized"></pre>
      <hr>
      <pre id="undecorate_error"></pre>
      <pre id="undecorated"></pre>
    </form>
  </body>
</html>
